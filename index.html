<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoveLink</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❤</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: sans-serif; background: #fff0f5; }
    #app { display: flex; flex-direction: column; height: 100%; }
    header { background: pink; padding: 10px; text-align: center; font-size: 1.5em; color: white; }
    main { flex: 1; display: flex; flex-direction: column; padding: 10px; }
    .map-container { flex: 1; display: flex; gap: 10px; }
    .map { flex: 1; height: 200px; border: 2px solid hotpink; border-radius: 10px; }
    #pairing { margin: 10px 0; text-align: center; }
    #code { font-size: 1.2em; font-weight: bold; color: #e91e63; }
    #qr { margin: 10px auto; display: block; }
    #batteryStatus { text-align: center; margin: 5px; }
    .heart-btn { background: none; border: none; font-size: 2em; color: red; cursor: pointer; margin: 10px auto; display: block; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <div id="app">
    <header>❤ LoveLink ❤</header>
    <main>
      <div id="pairing">
        Share this code/link: <span id="code"></span><br/>
        <canvas id="qr"></canvas>
      </div>
      <div class="map-container">
        <div id="mymap" class="map"></div>
        <div id="partnermap" class="map"></div>
      </div>
      <div id="batteryStatus"></div>
      <button class="heart-btn" id="notifyBtn">❤</button>
    </main>
  </div>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  <script>
    const secretKey = CryptoJS.lib.WordArray.random(16).toString();
    const code = location.pathname.split('/connect/')[1] || Math.floor(100000 + Math.random() * 900000).toString();
    document.getElementById("code").textContent = code;
    QRCode.toCanvas(document.getElementById('qr'), `https://lovelink.app/connect/${code}`);

    const socket = io();
    socket.emit('join', code);

    const encrypt = msg => CryptoJS.AES.encrypt(JSON.stringify(msg), secretKey).toString();
    const decrypt = msg => JSON.parse(CryptoJS.AES.decrypt(msg, secretKey).toString(CryptoJS.enc.Utf8));

    // Notification & Vibration
    document.getElementById("notifyBtn").addEventListener('click', () => {
      socket.emit("notify", encrypt({ code }));
    });

    socket.on("notify", data => {
      const msg = decrypt(data);
      if (msg.code === code) {
        navigator.vibrate?.(300);
        new Notification("Your partner sent you a ❤!");
      }
    });

    // Maps
    const myMap = L.map('mymap').setView([0, 0], 13);
    const partnerMap = L.map('partnermap').setView([0, 0], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(myMap);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(partnerMap);
    let myMarker = L.marker([0,0]).addTo(myMap);
    let partnerMarker = L.marker([0,0]).addTo(partnerMap);

    // Location + Battery
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      myMarker.setLatLng([latitude, longitude]);
      myMap.setView([latitude, longitude]);
      sendStatus(latitude, longitude);
    });

    function sendStatus(lat, lng) {
      navigator.getBattery().then(battery => {
        const percent = Math.round(battery.level * 100);
        let color = percent > 60 ? 'green' : percent > 30 ? 'orange' : 'red';
        document.getElementById('batteryStatus').innerHTML = `Battery: <span style="color:${color}">${percent}%</span>`;
        socket.emit('status', encrypt({ lat, lng, percent, code }));
      });
    }

    socket.on("status", data => {
      const msg = decrypt(data);
      if (msg.code === code) {
        partnerMarker.setLatLng([msg.lat, msg.lng]);
        partnerMap.setView([msg.lat, msg.lng]);
      }
    });

    // Ask for permissions
    if (Notification.permission !== 'granted') {
      Notification.requestPermission();
    }
  </script>
</body>
</html>
