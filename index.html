<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>LoveLink</n	>
  <link rel="manifest" href="manifest.json">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; display: flex; flex-direction: column; font-family: sans-serif; }
    #app { flex: 1; display: flex; flex-direction: column; }
    #header { padding: 1rem; text-align: center; background: #ffccd5; }
    #code, #map-container { flex: 1; display: flex; }
    #code { justify-content: center; align-items: center; }
    #qr { width: 150px; height: 150px; border: 1px solid #ccc; }
    #panels { display: flex; flex: 1; }
    .panel { flex: 1; position: relative; }
    .battery { position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 5px; background: lightgreen; color: #000; }
    #heart { position: fixed; bottom: 20px; right: 20px; font-size: 2rem; background: #ff6699; color: #fff; border: none; border-radius: 50%; width: 60px; height: 60px; }
    #notify { display: none; }
  </style>
</head>
<body>
<div id="app">
  <div id="header">
    <h1>LoveLink</h1>
    <div id="pairing">
      Code: <span id="pair-code"></span>
      <canvas id="qr"></canvas>
    </div>
  </div>
  <div id="panels">
    <div class="panel" id="you"><div id="map-you"></div><div id="bat-you" class="battery"></div></div>
    <div class="panel" id="them"><div id="map-them"></div><div id="bat-them" class="battery"></div></div>
  </div>
  <button id="heart">❤</button>
</div>

<!-- Dependencies -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
<script>
(async () => {
  // Generate 6-digit code
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  document.getElementById('pair-code').textContent = code;
  const url = `${location.origin}/connect/${code}`;
  // Generate QR
  const qrCanvas = document.getElementById('qr');
  new QRious({ element: qrCanvas, value: url, size: 150 });

  // Encryption key = code
  const key = CryptoJS.enc.Utf8.parse(code);

  // Initialize maps
  const mapYou = L.map('map-you').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapYou);
  const markerYou = L.marker([0,0]).addTo(mapYou);

  const mapThem = L.map('map-them').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapThem);
  const markerThem = L.marker([0,0]).addTo(mapThem);

  // Connect Socket.IO
  const socket = io({ path: '/socket.io' });
  socket.emit('join', code);

  // Geolocation + Battery
  const update = async () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const data = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const ct = CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
        socket.emit('encrypted', { payload: ct });
        markerYou.setLatLng([data.lat, data.lng]); mapYou.setView([data.lat,data.lng], 13);
      });
    }
    if (navigator.getBattery) {
      const bat = await navigator.getBattery();
      const pct = Math.floor(bat.level*100);
      const el = document.getElementById('bat-you'); el.textContent = pct + '%';
      el.style.background = pct>60?'lightgreen':pct>30?'yellow':'lightcoral';
      const ctBat = CryptoJS.AES.encrypt(JSON.stringify({ batt: pct }), key).toString();
      socket.emit('encrypted', { payload: ctBat });
    }
  };
  setInterval(update, 5000);

  // Receive encrypted
  socket.on('encrypted', data => {
    const dec = JSON.parse(CryptoJS.AES.decrypt(data.payload, key).toString(CryptoJS.enc.Utf8));
    if (dec.lat) { markerThem.setLatLng([dec.lat,dec.lng]); mapThem.setView([dec.lat,dec.lng], 13); }
    if (dec.batt!==undefined) {
      const el = document.getElementById('bat-them'); el.textContent = dec.batt + '%';
      el.style.background = dec.batt>60?'lightgreen':dec.batt>30?'yellow':'lightcoral';
    }
  });

  // Heart notification
  document.getElementById('heart').addEventListener('click', () => {
    const msg = CryptoJS.AES.encrypt(JSON.stringify({ notify: true }), key).toString();
    socket.emit('encrypted', { payload: msg });
  });
  socket.on('encrypted', data => {
    const dec = JSON.parse(CryptoJS.AES.decrypt(data.payload, key).toString(CryptoJS.enc.Utf8));
    if (dec.notify) {
      if (Notification.permission==='granted') new Notification('❤️ Your partner sent love!');
      else Notification.requestPermission();
      if (navigator.vibrate) navigator.vibrate(200);
    }
  });

  // Request permission
  if (Notification.permission!=='granted') Notification.requestPermission();
})();
